<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Users List</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_users_list.css') }}">
</head>
<body>
  <div class="back-link">
    <a href="{{ url_for('dashboard_home') }}">‚Üê Back</a> <br>
  </div>
  <div class="container">
    <h2>Registered Users</h2>
    <ul id="userList"></ul>
  </div>

  <div id="userModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3 id="modalFullName"></h3>
      <p id="modalEmail"></p>
      <p id="modalAddress"></p>
      <p id="modalPhone"></p>
      <p id="modalAccountActive"></p>
    </div>
  </div>

  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
  <script>
    function fetchUserData() {
      return fetch('/api/users')
        .then(response => {
          if (!response.ok) {
            throw new Error("Failed to fetch user data");
          }
          return response.json();
        });
    }

    function createUserListItem(user) {
      const listItem = document.createElement("li");
      const userInfo = document.createElement("span");
      userInfo.textContent = `${user.full_name} (${user.email})`;

      const viewBtn = document.createElement("button");
      viewBtn.textContent = "View";

      const updateBtn = document.createElement("button");
      updateBtn.textContent = "Update";

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";

      listItem.appendChild(userInfo);
      listItem.appendChild(viewBtn);
      listItem.appendChild(updateBtn);
      listItem.appendChild(deleteBtn);

      return listItem;
    }

    function handleUserListClick(event) {
      const target = event.target;
      if (target.tagName === "BUTTON" && target.textContent === "View") {
        const listItem = target.parentNode;
        const userId = listItem.dataset.userId;

        // Fetch user details and open the modal
        fetch(`/api/users/${userId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error("Failed to fetch user details");
            }
            return response.json();
          })
          .then(user => {
            // Populate the modal with user details
            document.getElementById("modalFullName").textContent = user.full_name;
            document.getElementById("modalEmail").textContent = user.email;
            document.getElementById("modalAddress").textContent = user.address;
            document.getElementById("modalPhone").textContent = user.phone;
            document.getElementById("modalAccountActive").textContent = user.account_activation_status ? 'Yes' : 'No';

            // Open the modal
            const modal = document.getElementById("userModal");
            modal.style.display = "block";
          })
          .catch(error => {
            console.error("Error fetching user details:", error);
            // You might want to display an error message on the page as well
          });
      } else if (target.tagName === "BUTTON") {
        const listItem = target.parentNode;
        const userId = listItem.dataset.userId;

        if (target.textContent === "Update") {
          window.location.href = `/dashboard/manager/update=user_id?id=${obfuscate_id(userId)}`;
        } else if (target.textContent === "Delete") {
          if (confirm(`Warning! Are you sure you want to delete ${listItem.querySelector("span").textContent}?`)) {
            fetch(`/api/users/${userId}`, { method: "DELETE" })
              .then(response => {
                if (response.ok) {
                  listItem.remove();
                } else {
                  console.error("Failed to delete user");
                }
              })
              .catch(error => {
                console.error("Error deleting user:", error);
              });
          }
        }
      }
    }

    const userList = document.getElementById("userList");
    userList.addEventListener("click", handleUserListClick);

    fetchUserData()
      .then(users => {
        users.forEach(user => {
          const listItem = createUserListItem(user);
          listItem.dataset.userId = user.id;
          userList.appendChild(listItem);
        });
      })
      .catch(error => {
        console.error("Error fetching users:", error);
      });

    // Add event listener to close the modal
    const modal = document.getElementById("userModal");
    const closeBtn = document.querySelector(".close-btn");
    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });
  </script>
</body>
</html>
